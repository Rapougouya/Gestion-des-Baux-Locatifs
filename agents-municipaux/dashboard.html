<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - Agent Municipal | PNSBIL</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/pages/dashb_municipal.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Indicateur de chargement -->
        <div class="loading-indicator" id="loadingIndicator"></div>

        <header class="dashboard-header">
            <div class="header-content">
                <div class="logo">
                    <span>🏠 PNSBIL</span>
                    <span>Espace Agent Municipal</span>
                </div>
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="user-menu">
                    <span class="user-name" id="userName">Mairie de Ouagadougou</span>
                    <button class="btn btn-outline" onclick="logout()">Déconnexion</button>
                </div>
            </div>
        </header>

        <nav class="sidebar" id="sidebar">
            <div class="nav-section">
                <h3>Gestion Municipale</h3>
                <a href="dashboard.html" class="nav-link active">📊 Tableau de bord</a>
                <a href="validation-cadastre.html" class="nav-link">🏠 Validation Cadastre</a>
                <a href="controle-baux.html" class="nav-link">📑 Contrôle des Baux</a>
                <a href="mediation.html" class="nav-link">⚖️ Médiation</a>
                <a href="rapports-locaux.html" class="nav-link">📈 Rapports Locaux</a>
            </div>
            <div class="nav-section">
            <div class="nav-title">Support</div>
            <a href="support.html" class="nav-link">
                <span class="nav-icon">🛟</span>
                <span>Centre d'aide</span>
            </a>
            <a href="parametres.html" class="nav-link">
                <span class="nav-icon">⚙️</span>
                <span>Paramètres</span>
            </a>
        </div>
        </nav>

        <main class="main-content">
            <div class="page-header">
                <h1>Tableau de Bord Municipal</h1>
                <p>Vue d'ensemble des activités immobilières sur votre territoire</p>
            </div>

            <!-- Statistiques Municipales -->
            <div class="stats-grid">
                <div class="stat-card municipal">
                    <div class="stat-icon">🏘️</div>
                    <div class="stat-content">
                        <div class="stat-value" id="stat-properties">2,847</div>
                        <div class="stat-label">Biens enregistrés</div>
                        <div class="stat-change positive">+12% ce trimestre</div>
                    </div>
                </div>
                <div class="stat-card municipal">
                    <div class="stat-icon">📑</div>
                    <div class="stat-content">
                        <div class="stat-value" id="stat-leases">1,924</div>
                        <div class="stat-label">Baux validés</div>
                        <div class="stat-change positive">+8%</div>
                    </div>
                </div>
                <div class="stat-card municipal">
                    <div class="stat-icon">⚖️</div>
                    <div class="stat-content">
                        <div class="stat-value" id="stat-mediations">23</div>
                        <div class="stat-label">Médiations en cours</div>
                        <div class="stat-change negative">+5 cette semaine</div>
                    </div>
                </div>
                <div class="stat-card municipal">
                    <div class="stat-icon">💰</div>
                    <div class="stat-content">
                        <div class="stat-value" id="stat-taxes">156M FCFA</div>
                        <div class="stat-label">Taxes collectées</div>
                        <div class="stat-change positive">+18%</div>
                    </div>
                </div>
            </div>

            <div class="dashboard-content">
                <!-- Alertes et Actions Urgentes -->
                <div class="dashboard-section">
                    <div class="section-header">
                        <h3>🔄 Actions Requises</h3>
                        <span class="badge badge-warning">8 en attente</span>
                    </div>
                    <div class="actions-list" id="actionsList">
                        <div class="action-item urgent">
                            <div class="action-icon">⚠️</div>
                            <div class="action-content">
                                <div class="action-title">Validation cadastrale en retard</div>
                                <div class="action-desc">15 biens nécessitent une validation urgente</div>
                                <div class="action-date">Échéance: Aujourd'hui</div>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="handleAction(1)">Traiter</button>
                        </div>
                        <div class="action-item">
                            <div class="action-icon">📋</div>
                            <div class="action-content">
                                <div class="action-title">Contrôle de conformité</div>
                                <div class="action-desc">8 baux nécessitent une vérification</div>
                                <div class="action-date">Échéance: 3 jours</div>
                            </div>
                            <button class="btn btn-sm btn-outline" onclick="handleAction(2)">Examiner</button>
                        </div>
                        <div class="action-item">
                            <div class="action-icon">⚖️</div>
                            <div class="action-content">
                                <div class="action-title">Demandes de médiation</div>
                                <div class="action-desc">5 nouveaux conflits locatifs</div>
                                <div class="action-date">En attente</div>
                            </div>
                            <button class="btn btn-sm btn-outline" onclick="handleAction(3)">Voir</button>
                        </div>
                    </div>
                </div>

                <!-- Carte du Territoire -->
                <div class="dashboard-section">
                    <div class="section-header">
                        <h3>🗺️ Vue Territoriale</h3>
                    </div>
                    <div class="municipal-map">
                        <div class="map-placeholder">
                            <i class="fas fa-map-marked-alt"></i>
                            <p>Carte interactive du territoire municipal</p>
                            <small>Zones de forte activité immobilière mises en évidence</small>
                        </div>
                        <div class="map-legend">
                            <div class="legend-item">
                                <span class="legend-color high-activity"></span>
                                <span>Forte activité</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color medium-activity"></span>
                                <span>Activité moyenne</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color low-activity"></span>
                                <span>Faible activité</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activité Récente -->
            <div class="dashboard-section full-width">
                <div class="section-header">
                    <h3>📋 Activité Récente</h3>
                    <button class="btn btn-sm btn-outline" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Actualiser
                    </button>
                </div>
                <div class="recent-activity">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Quartier</th>
                                <th>Statut</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivityBody">
                            <tr>
                                <td>15/03/2024</td>
                                <td>Validation</td>
                                <td>Résidence Les Almadies - Appartement B12</td>
                                <td>Almadies</td>
                                <td><span class="status-badge pending">En attente</span></td>
                                <td><button class="btn btn-sm btn-outline" onclick="handleActivity(1)">Valider</button></td>
                            </tr>
                            <tr>
                                <td>14/03/2024</td>
                                <td>Contrôle</td>
                                <td>Contrôle bail - Villa Mermoz</td>
                                <td>Mermoz</td>
                                <td><span class="status-badge completed">Terminé</span></td>
                                <td><button class="btn btn-sm btn-outline" onclick="handleActivity(2)">Voir</button></td>
                            </tr>
                            <tr>
                                <td>13/03/2024</td>
                                <td>Médiation</td>
                                <td>Conflit locatif - Rue 10 x 12</td>
                                <td>Plateau</td>
                                <td><span class="status-badge in-progress">En cours</span></td>
                                <td><button class="btn btn-sm btn-outline" onclick="handleActivity(3)">Intervenir</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <!-- Footer -->
<footer>
    <div class="footer-container">
        <div class="footer-grid">
            <div class="footer-section">
                <h5>PNSBIL</h5>
                <p>Plateforme Nationale de Suivi des Baux et Perception des Impôts Locatifs</p>
                <p>Modernisation et digitalisation de la gestion du marché locatif.</p>
            </div>
            <div class="footer-section">
                <h5>Liens rapides</h5>
                <ul class="footer-links">
                    <li><a href="index.html"><i class="fas fa-home"></i>Accueil</a></li>
                    <li><a href="properties.html"><i class="fas fa-building"></i>Propriétés</a></li>
                    <li><a href="leases.html"><i class="fas fa-file-contract"></i>Baux</a></li>
                    <li><a href="taxes.html"><i class="fas fa-chart-line"></i>Impôts</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h5>Ressources</h5>
                <ul class="footer-links">
                    <li><a href="#"><i class="fas fa-question-circle"></i>FAQ</a></li>
                    <li><a href="#"><i class="fas fa-book"></i>Guides</a></li>
                    <li><a href="#"><i class="fas fa-envelope"></i>Contact</a></li>
                    <li><a href="#"><i class="fas fa-gavel"></i>Mentions légales</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h5>Contact</h5>
                <ul class="footer-links footer-contact">
                    <li>
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Avenue XXXXX,<br>Ouagadougou, Burkina Faso</span>
                    </li>
                    <li>
                        <i class="fas fa-phone"></i>
                        <span>+226 33 123 45 67</span>
                    </li>
                    <li>
                        <i class="fas fa-envelope"></i>
                        <span>contact@pnsbil.bf</span>
                    </li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 PNSBIL - Tous droits réservés</p>
        </div>
    </div>
</footer>
    </div>

    <script>
        // Configuration et constantes
        const CONFIG = {
            API_BASE_URL: '/api/v1',
            UPDATE_INTERVAL: 30000, // 30 secondes
            ANIMATION_DELAY: 150
        };

        // État de l'application
        class DashboardState {
            constructor() {
                this.stats = {};
                this.actions = [];
                this.recentActivity = [];
                this.isLoading = false;
            }
        }

        // Instance de l'état
        const state = new DashboardState();

        // Gestionnaire du dashboard
        class DashboardManager {
            constructor() {
                this.init();
            }

            async init() {
                try {
                    await this.loadInitialData();
                    this.setupEventListeners();
                    this.startAutoRefresh();
                    this.initializeAnimations();
                } catch (error) {
                    console.error('Erreur lors de l\'initialisation:', error);
                    this.showError('Erreur de chargement du tableau de bord');
                }
            }

            async loadInitialData() {
                this.setLoading(true);
                
                await Promise.all([
                    this.loadStats(),
                    this.loadPendingActions(),
                    this.loadRecentActivity()
                ]);
                
                this.setLoading(false);
            }

            async loadStats() {
                try {
                    const stats = await this.fetchStats();
                    this.updateStatsDisplay(stats);
                    state.stats = stats;
                } catch (error) {
                    console.error('Erreur chargement stats:', error);
                    throw error;
                }
            }

            async loadPendingActions() {
                try {
                    const actions = await this.fetchPendingActions();
                    this.renderActionsList(actions);
                    state.actions = actions;
                } catch (error) {
                    console.error('Erreur chargement actions:', error);
                    throw error;
                }
            }

            async loadRecentActivity() {
                try {
                    const activity = await this.fetchRecentActivity();
                    this.renderRecentActivity(activity);
                    state.recentActivity = activity;
                } catch (error) {
                    console.error('Erreur chargement activité:', error);
                    throw error;
                }
            }

            // Méthodes de simulation d'API
            async fetchStats() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({
                            properties: 2847,
                            leases: 1924,
                            mediations: 23,
                            taxes: 156000000
                        });
                    }, 1000);
                });
            }

            async fetchPendingActions() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve([
                            {
                                id: 1,
                                type: 'validation',
                                title: 'Validation cadastrale en retard',
                                description: '15 biens nécessitent une validation urgente',
                                date: 'Aujourd\'hui',
                                priority: 'high',
                                action: 'Traiter'
                            },
                            {
                                id: 2,
                                type: 'control',
                                title: 'Contrôle de conformité',
                                description: '8 baux nécessitent une vérification',
                                date: '3 jours',
                                priority: 'medium',
                                action: 'Examiner'
                            },
                            {
                                id: 3,
                                type: 'mediation',
                                title: 'Demandes de médiation',
                                description: '5 nouveaux conflits locatifs',
                                date: 'En attente',
                                priority: 'medium',
                                action: 'Voir'
                            }
                        ]);
                    }, 800);
                });
            }

            async fetchRecentActivity() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve([
                            {
                                id: 1,
                                date: '15/03/2024',
                                type: 'Validation',
                                description: 'Résidence Les Almadies - Appartement B12',
                                neighborhood: 'Almadies',
                                status: 'pending',
                                action: 'Valider'
                            },
                            {
                                id: 2,
                                date: '14/03/2024',
                                type: 'Contrôle',
                                description: 'Contrôle bail - Villa Mermoz',
                                neighborhood: 'Mermoz',
                                status: 'completed',
                                action: 'Voir'
                            },
                            {
                                id: 3,
                                date: '13/03/2024',
                                type: 'Médiation',
                                description: 'Conflit locatif - Rue 10 x 12',
                                neighborhood: 'Plateau',
                                status: 'in-progress',
                                action: 'Intervenir'
                            }
                        ]);
                    }, 600);
                });
            }

            // Mise à jour de l'affichage
            updateStatsDisplay(stats) {
                this.animateValue('stat-properties', stats.properties);
                this.animateValue('stat-leases', stats.leases);
                this.animateValue('stat-mediations', stats.mediations);
                this.formatTaxesDisplay(stats.taxes);
            }

            animateValue(elementId, targetValue) {
                const element = document.getElementById(elementId);
                if (!element) return;

                const duration = 2000;
                const start = 0;
                const increment = targetValue / (duration / 16);
                let current = start;

                const timer = setInterval(() => {
                    current += increment;
                    if (current >= targetValue) {
                        clearInterval(timer);
                        current = targetValue;
                    }
                    element.textContent = Math.floor(current).toLocaleString();
                }, 16);
            }

            formatTaxesDisplay(amount) {
                const element = document.getElementById('stat-taxes');
                if (element) {
                    element.textContent = `${(amount / 1000000).toFixed(0)}M FCFA`;
                }
            }

            renderActionsList(actions) {
                const container = document.getElementById('actionsList');
                if (!container) return;

                container.innerHTML = actions.map(action => `
                    <div class="action-item ${action.priority === 'high' ? 'urgent' : ''}" 
                         data-action-id="${action.id}">
                        <div class="action-icon">${this.getActionIcon(action.type)}</div>
                        <div class="action-content">
                            <div class="action-title">${action.title}</div>
                            <div class="action-desc">${action.description}</div>
                            <div class="action-date">Échéance: ${action.date}</div>
                        </div>
                        <button class="btn btn-sm ${action.priority === 'high' ? 'btn-primary' : 'btn-outline'}"
                                onclick="handleAction(${action.id})">
                            ${action.action}
                        </button>
                    </div>
                `).join('');
            }

            renderRecentActivity(activities) {
                const tbody = document.getElementById('recentActivityBody');
                if (!tbody) return;

                tbody.innerHTML = activities.map(activity => `
                    <tr data-activity-id="${activity.id}">
                        <td>${activity.date}</td>
                        <td>${activity.type}</td>
                        <td>${activity.description}</td>
                        <td>${activity.neighborhood}</td>
                        <td><span class="status-badge ${activity.status}">${this.getStatusText(activity.status)}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline" 
                                    onclick="handleActivity(${activity.id})">
                                ${activity.action}
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            getActionIcon(type) {
                const icons = {
                    validation: '📋',
                    control: '⚖️',
                    mediation: '🔍'
                };
                return icons[type] || '📄';
            }

            getStatusText(status) {
                const statusMap = {
                    pending: 'En attente',
                    completed: 'Terminé',
                    'in-progress': 'En cours'
                };
                return statusMap[status] || status;
            }

            // Gestion des événements
            setupEventListeners() {
                // Navigation
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', this.handleNavigation.bind(this));
                });

                // Menu mobile
                document.getElementById('mobileMenuToggle').addEventListener('click', this.toggleMobileMenu.bind(this));

                // Fermer le menu mobile en cliquant à l'extérieur
                document.addEventListener('click', (event) => {
                    const sidebar = document.getElementById('sidebar');
                    const menuToggle = document.getElementById('mobileMenuToggle');
                    if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
                        sidebar.classList.remove('mobile-open');
                    }
                });
            }

            handleNavigation(event) {
                event.preventDefault();
                const target = event.currentTarget;
                
                // Mise à jour de l'état actif
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                target.classList.add('active');

                // Animation de transition
                this.animatePageTransition(target.href);
            }

            animatePageTransition(url) {
                document.body.style.opacity = '0.7';
                setTimeout(() => {
                    window.location.href = url;
                }, 300);
            }

            toggleMobileMenu() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('mobile-open');
            }

            setLoading(loading) {
                state.isLoading = loading;
                const loader = document.getElementById('loadingIndicator');
                if (loader) {
                    loader.style.display = loading ? 'block' : 'none';
                }
            }

            initializeAnimations() {
                // Animation d'entrée des cartes
                const cards = document.querySelectorAll('.stat-card, .dashboard-section');
                cards.forEach((card, index) => {
                    card.style.animationDelay = `${index * CONFIG.ANIMATION_DELAY}ms`;
                });

                // Observateur d'intersection pour l'animation au scroll
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.style.opacity = '1';
                            entry.target.style.transform = 'translateY(0)';
                        }
                    });
                }, { threshold: 0.1 });

                document.querySelectorAll('.stat-card, .action-item').forEach(el => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(20px)';
                    el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                    observer.observe(el);
                });
            }

            startAutoRefresh() {
                setInterval(() => {
                    this.loadStats();
                }, CONFIG.UPDATE_INTERVAL);
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <div class="notification-content">
                        <span class="notification-message">${message}</span>
                        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }

            showError(message) {
                this.showNotification(message, 'error');
            }
        }

        // Initialisation au chargement de la page
        let dashboard;
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new DashboardManager();
        });

        // Fonctions globales
        function handleAction(actionId) {
            const action = state.actions.find(a => a.id === actionId);
            if (action) {
                dashboard.showNotification(`Traitement de l'action: ${action.title}`, 'info');
            }
        }

        function handleActivity(activityId) {
            const activity = state.recentActivity.find(a => a.id === activityId);
            if (activity) {
                dashboard.showNotification(`Ouverture de: ${activity.description}`, 'info');
            }
        }

        function refreshData() {
            dashboard.loadInitialData();
            dashboard.showNotification('Données rafraîchies', 'success');
        }

        function logout() {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                dashboard.showNotification('Déconnexion réussie', 'success');
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 1500);
            }
        }

        // Gestion des erreurs globales
        window.addEventListener('error', (event) => {
            console.error('Erreur globale:', event.error);
            dashboard.showError('Une erreur inattendue est survenue');
        });

        // Gestion de la visibilité de la page
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && dashboard) {
                dashboard.loadStats();
            }
        });
    </script>
</body>
</html>